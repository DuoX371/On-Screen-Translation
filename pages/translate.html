<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OST Main Window</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net/ https://html2canvas.hertzen.com/;" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

  <style>
    .btn-pos{
      position: absolute;
      bottom: 10px;
      left: 45%;
    }
  </style>
</head>
<body class="container" style="height: 100%">
  <div class="translated-content">
    test
  </div>
  <video id="video" autoplay class="d-none"></video>

  <div class="btn-pos">
    <button class="btn btn-success" id="translate">text</button>
  </div>
</body>

<script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
  document.getElementById("translate").addEventListener("click", translate);

  const videoElem = document.getElementById("video");
  let selectedSource = {}

  navigator.mediaDevices.getDisplayMedia = async () => {
    // create MediaStream
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: {
        mandatory: {
          chromeMediaSource: "screen",
          chromeMediaSourceId: selectedSource.id,
          minWidth: selectedSource.bounds.width,
          maxWidth: selectedSource.bounds.width,
          minHeight: selectedSource.bounds.height,
          maxHeight: selectedSource.bounds.height,
        },
      },
    });

    return stream;
  };

  async function translate(){
    // get capture window id and sizes
    const ss = await window.electron.sendScreenshotSignal();
    selectedSource = ss;

    // Start streaming the video feedbck to the video element
    videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia();  

    // Create canvas to convert the stremed video to image
    let canvas = document.createElement("canvas");
    let context = canvas.getContext("2d");
    canvas.width = ss.bounds.width;
    canvas.height = ss.bounds.height;

    // Wait for the video to initialize. then draw the image to canvas
    setTimeout(async () => {
      context.drawImage(video, 0, 0, ss.bounds.width, ss.bounds.height);
    
      // Stop the streaming since we already captured the video
      let tracks = videoElem.srcObject.getTracks();
      tracks.forEach((track) => track.stop());

      console.log(canvas.toDataURL()); // Image in base64 >> can process to image to text
      
      const res = await window.electron.sendImageToText({ 
        img: canvas.toDataURL(),
        // lang: 'jpn' // (optional)
      })
      console.log(res)
    }, 500)
  }
  
</script>
</html>